This   guide  covers  the  configuration  and   initialization   features  available  to   Rails   applications ▖
*   いかに ユーザー を 管理 す べ き か   ( ログ イン / ログ アウト の しくみ 、 あらゆる レイヤ に お け る 攻撃 方法 の 解説 )
広 く 使用 さ れ て い る Apache   Web サーバー に は   DocumentRoot と い う オプション が あ り ま す ▟   web  server   has an  option   called   DocumentRoot ▖  
NOTE : _ セッション を 無 期限 に する と 、 攻撃 さ れ る 機会 を 増や し て しま い ま す   ( クロス サイト リクエストフォージェリ   ( CSRF ) 、 セッション ハイジャック 、 セッション 固定 など ) 。
ユーザー に は   _ ログ アウト ボタン _   を 提供 し な けれ ば な り ま せ ん ▟ それ も   _ よく 目立 つ ボタン _  を 。
この 対応 策 は 、 セッション ハイジャック に も 有効 で す 。
World   Wide   Web   Consortium   ( W 3 C )   は 、 HTTP の GET や POST を 選択 する 際 の チェックリスト を 提供 し て い ま す 。
    return false ; " > To  the   harmless  survey </a>
*   w w w ▖ webapp▖ com   の Web アプリケーション は 、 リクエスト に 対応 する セッション ハッシュ に 含 ま れ る ユーザー 情報 が 有効 で あ る と 認定 し 、 その 指示 に 従 っ て ID   1 の プロジェクト を 削除 し ま す 。
< a   href = " http://www ▖harmless▖ com/"   onclick = "
リダイレクト 用 の URL   ( の 一部 )   を ユーザー が 受け入れ て しま う と 、 潜在 的 な 脆弱 性 と な り ま す 。
``` ruby
_ IP アドレス は セッション の 過程 で 変わ る 可能 性 が あ る _   ため 、 IP アドレス を ユーザー 固有 の 情報 と し て 使用 し よう と する と 、 ユーザー が Web アプリケーション に アクセス でき な く な っ たり 、 ユーザー の 使用 に 制限 が 加わ る 可能 性 が あ り ま す 。
*   ユーザー が クレジット を 受け取 る ▟ 総額 は セッション に 保存 さ れ て い る   ( もちろん これ が ダメ ダメ な の は わか っ て い ま す ▟ あくまで 説明 の ため の もの で す ) 。
この ランダム な 文字 列 は 、 現在 時刻 、 0 から 1 まで の 乱数 、 Ruby インタープリタ の プロセス id   ( これ も 基本 的 に は 乱数 で す ) 、 および 一定 の 文字 列 で す 。
HTTP プロトコル は 2 つ の 基本 的 な リクエスト で あ る GET と POST を 提供 し て い ま す   ( これ 以外 の リクエスト も 制定 さ れ て い ま す が 、 大半 の ブラウザ で サポート さ れ て い ま せ ん ) 。
リ ダイ レクション URL 攻撃 で は 、 攻撃 者 が この よう な 悪意 の あ る コード を 含 ん だ URL へ の リダイレクト を 行 い ま す 。
< img   src= " http://www ▖harmless▖ com/img "   width = " 400 "   height = " 400 "   onmouseover = " ▖▖▖ "  
TIP: _` CookieStore ` を 扱 う の で あ れ ば 、 もう 一 つ の 攻撃 方法 で あ る 「 再生 攻撃   ( replay   attack ) 」 に つ い て も 知 っ て お く 必要 が あ り ま す 。
*   攻撃 者 は 、 Java Script を 仕込 ん だ ページ に 標的 ユーザー を 誘い 込 み ま す 。
はじめ に
どちら の 場合 に も 、 ブラウザ は リクエスト の たび に cookie を 自動 的 に ドメイン に 送信 し ま す   ( その ドメイン で 使用 でき る cookie が あ る 場合 ) 。
これ に 対 する 最良 の 対応 策 は 、  _ メディア ファイル を 非 同期 的 に 処理 する こと _  で す ▟ メディア ファイル を 保存 し 、 その 後 データベース 内 へ の 処理 の リクエスト を スケジューリング し ま す 。
Web アプリケーション の 開発 者 に と っ て は 、 これ は  _ SSL に よ る 安全 な 接続 の 提供 _   が 必要 で あ る と い う こと で す 。
###  セッション id
一般 に 、 導入 する だけ で たちまち セキュリティ を 保 つ こと が でき る よう な 便利 な もの は あ り ま せ ん 。
しかも 、 その セッション が クライアント 側 に 保存 さ れ て い る と 、 ユーザー が その データ を 読 む こと が でき て しま い ま す 。
さらに 、 攻撃 者 が 金儲け また は 企業 資産 の 改ざん に よ る 企業 イメージ 損壊 の 目的 で 、 トロイ の 木馬 プログラム や 迷惑 メール 自動 送信 プログラム を 仕込 ん だり する こと も あ り え ま す 。
無線 LAN は 、 まさに その よう な ネットワーク の 一 例 で す 。
def  legacy
    f▖style▖ display   = 'none ';
* * 以下 の 場合 は POST を 使用 する こと * *
    #  最終 的 に 非 英数 文字 を アンダース コア また は
( attachment_fu   プラグ イン が 画像 に 対 し て 行な う よう に )   ファイル の アップロード を 同期 的 に 行な う と 、 セキュリティ 上 かなり 不利 に な り ま す ▟ _ サービス 拒否   ( DoS )   攻撃 の 脆弱 性 _   が 生じ る ため で す 。
この 種 の 偽造 リクエスト を すべて 防止 する に は 、  _ 必須 セキュリティ トークン _   を 導入 し ま す ▟ この トークン は 自分 の サイト だけ が 知 っ て お り 、 他 の サイト は 知 り ま せ ん 。
サーバー 側 で は 、 セッション が 改竄 さ れ る こと を 防 ぐ ため に 、 サーバー 上 の 秘密 キー を 元 に セッション から ダイジェスト を 計算 し て それ を cookie の 末尾 に 挿入 し て い ま す 。
Rails   3 ▖ 1 以降 で は 、 アプリケーション の 設定 ファイル で SSL 接続 を 強制 する こと に よ っ て 達成 でき ま す 。
*   ハッカー に よ る 書き込み が ブラウザ で 表示 さ れ る と 、 ブラウザ は image タグ を 見つけ ま す 。
最後 の ユーザー が Web アプリケーション から ログ アウト する の を 忘れ て 立ち去 っ て い た ら 、 次 の ユーザー は その Web アプリケーション を その まま 使え て しま い ま す 。
ユーザー が 既に アプリケーション を 使用 中 で あ れ ば 、 既存 の セッション を 読み込 み ま す 。
この よう に 、 cookie は Web アプリケーション に 一時 的 な 認証 機能 を 提供 し て い ま す 。
     config ▖ force _ ssl  =  true
この 節 で は 、 セッション 保持 の 問題 の ところ で 触れ た セッション 固定 攻撃 に つ い て 説明 し ま す 。
クロス サイト スクリプティング   ( XSS )   に よ っ て Java Script コード の 注入   ( インジェクション )   に 成功 すれ ば 、 攻撃 は 完了 で す 。
--------------------------------------------------------------------------------
前述 の メソッド は ` Application Controller ` に 置 く こと が でき ま す ▟ そして 、 非 GET リクエスト に CSRF トークン が な い 場合 や トークン が 無効 な 場合 に この メソッド が 呼び出 さ れ ま す 。
###  セッション 固定 攻撃   -   対応 策
サーバー は その cookie から セッション ハッシュ を 読み出 す こと で 、 セッション id を 使用 せ ず に 済 み ま す 。
####  自己 完結 型 XSS
def sanitize_filename ( filename )
XSS 脆弱 性 が 存在 する と 、 攻撃 者 は Web ページ の あらゆる 要素 に アクセス でき て しま い ま す ▟ その ため 、 フォーム から CSRF セキュリティ トークン を 読み だ し て その フォーム を 直接 送信 する こと が でき て しま い ま す 。
この マニュアル で は 、 Web アプリケーション 全般 に お け る セキュリティ の 問題 と 、 Rails で それ ら の 問題 を 回避 する 方法 に つ い て 説明 し ま す 。
* _ セッション に 重要 な データ を 保存 し な い こと ▟_ 
最も あからさま な 攻撃 方法 と し て は 、 ユーザー を 本物 そっくり の 偽 Web サイト に リダイレクト する こと が 考え られ ま す 。
詳細 に つ い て は 、 Rails の アップグレード に 関 する ドキュメント を 参照 し て くださ い 。
こう する こと で 、 同期 に 関 し て 悩 ま ず に 済 み 、 セッション の ストレージ 容量 が あふれ る こと も あ り ま せ ん ( セッション の 格納 先 を どこ に する か に も よ り ま す が :   後述 ) 。
/\ A▖* (\\|\/)/ ,  ' '
    f ▖ submit ( ) ;
実際 の ところ 、 ある フレームワーク は 他 の より も 安全 で あ る と い う こと は 一概 に は 言え ま せ ん ▟ 正し く 用い る こと が でき て い る の で あ れ ば 、 たいてい の フレームワーク で 安全 な Web アプリケーション を 構築 でき ま す   ( 逆 に 言 え ば 、 正し く 用い られ て い な けれ ば どんな Web アプリケーション を 採用 し よう と も 安全 を 保 つ こと は でき ま せ ん ) 。
上 の sweep メソッド で 以下 の コード を 使用 し ま す 。
この 例 で は Base 64 で エンコード さ れ た Java Script を 使用 し て い ま す ▟ この Java Script は 単に メッセージ ボックス を 表示 し ま す 。
その 中 に は セキュリティ を 比較 的 高め やす い フレームワーク も あ り ま す 。
接続 さ れ て い る クライアント の すべて の トラフィック を のぞき見 る こと は 、 暗号 化 さ れ て い な い 無線 LAN で は 特に 簡単 に 行な う こと が でき ま す 。
    end
ユーザー 固有 の プロパティ と し て 利用 可能 な 情報 に は 、 リモート IP アドレス や   user   agent  ( =   web ブラウザ の 名前 )   が あ り ま す が 、 後者 は 完全 に ユーザー 固有 と は 限 り ま せ ん 。
  end
従 っ て 、 _ 秘密 キー に は 安易 な もの ( 辞書 から 抽出 し た 単語 や 、 30 文字 より 短 い 文字 列 ) を 使用 す べ き で は あ り ま せ ん ▟ _
* _ セッション に は 巨大 な オブジェクト を 格納 し な い こと _ 。
Rails は 、 ユーザー が アプリケーション に 新し く アクセス する とき に 自動 的 に セッション を 作成 し ま す 。
セキュリティ は 、 フレームワーク を 使用 する 人間 に 強 く 依存 し ま す ▟ 場合 に よ っ て は 開発 方法 も セキュリティ に 影響 する こと が あ り ま す 。
これ で 、 期限 を 過ぎ た セッション を 削除 でき ま す 。
セッション id を 持 つ cookie の タイム スタンプ に 有効 期限 を 設定 する と い う 対応 策 も 考え られ な く は あ り ま せ ん 。
この 攻撃 で は 、 ブラウザ 上 の ユーザー の セッション id を 攻撃 者 が 知 っ て い る セッション id に 密か に 固定 し て お き 、 ブラウザ を 使 う ユーザー が 気付 か な い うち に その セッション id を 強制 的 に 使 わ せ ま す 。
---------------------
*   ボブ は 掲示 板 を ブラウザ で 眺め て い て 、 とある ハッカー に よ る 書き込み を 目 に し ま す ▟ その 書き込み に は 仕掛け の あ る HTML  image 要素 が 含 ま れ て い ま す 。
この 攻撃 方法 は 、 ユーザー に よ る 認証 が 完了 し た と 考え られ る Web アプリケーション の ページ に 、 悪意 の あ る コード や リンク を 仕込 む と い う もの で す 。
    redirect_to ( params ▖ update ( action : 'main') )
###  CookieStore セッション に 対 する 再生 攻撃
###  ファイル アップロード で 実行 可能 な コード を 送り込 む
*   ファイル の 取扱い 上 の 注意 、 管理 インターフェイス を 提供 する 際 の 注意
しかし 、 ブラウザ 内 に 保存 さ れ て い る cookie を ユーザー が 編集 でき て しま う 点 は 変わ ら な い の で 、 やはり サーバー 側 で セッション を 期限 切れ に する 方 が 安全 で す 。
気 を 付け て いただ き た い の は 、  _ クロス サイト スクリプティング   ( XSS )   脆弱 性 は 、 あらゆる CSRF 保護 を 迂回 し て しま う _  と い う こと で す 。
*   Web サイト を 開 く だけ で セキュリティ 問題 が 発生 する しくみ   ( CSRF )
` Session ▖sweep ( " 20   minutes " ) ` を 呼 ぶ と 、 20 分 以上 経過 し た セッション が 期限 切れ に な り ま す 。
MD 5 は 現在 まで 破 ら れ て い ま せ ん が 、 若干 の 衝突 が 発生 し て い る ため 、 同じ ハッシュ 値 を 異な る 入力 テキスト から 生成 する こと は 「 理論 的 に は 」 不 可能 で は あ り ま せ ん 。
###  セッション ハイジャック
nonce を データベース に 保存 し て しま う と 、 せっかく データベース へ の アクセス を 避け る ため に 設置 し た CookieStore を 使用 する 意味 が なくな っ て しま い ま す 。
###  セッション ストレージ
       secret_key_ base :   492 f ▖ ▖▖
攻撃 者 は 、 同期 的 に 行 わ れ る 画像 ファイル アップロード を 多数 の コンピュータ から 同時 に 実行 する こと で 、 サーバー に 高 負荷 を かけ て 最終 的 に サーバー を クラッシュ また は 動作 停止 に 陥 ら せ ま す 。
これ は Web サイト の ホーム ディレクトリ で あ り 、 この ディレクトリ ツリー に 置 か れ て い る もの は すべて Web サーバー に よ っ て 取り扱 わ れ ま す 。
NOTE : _ HTTP は ステートレス の プロトコル で す 。
ショッピング サイト の 買い物 カゴ や 、 現在 ログ イン し て い る ユーザー の id など が これ に 該当 し ま す 。
_ URL を リダイレクト する 場合 は 、 ホワイト リスト また は 正規 表現 と 照合 する よう に し て くださ い ▟ _
この リンク は その Web アプリケーション の URL で 始ま っ て い る の で 、 一見 無害 に 見え ま す ▟ 危険 な サイト に 導 く URL は リダイレクト の パラメータ の 中 に 隠 さ れ て い ま す   ( http://www ▖example ▖ com/site/redirect ? to =   w w w ▖attacker▖ com ) 。
      time = time▖split▖ inject  { | count ,  unit|   count▖ to_ i ▖send ( unit )   }
実行 さ れ る 可能 性 の あ る 拡張 子 は 、 たとえば PHP や CGI など で す 。
詳細 に つ い て は 後述 の セッション 固定 に 関 する 記述 を 参照 し て くださ い 。
セッション id の 例 : `< script> document▖ cookie ="_session_id = 16 d 5 b 78abb28e 3 d 6206 b 60 f 22 a03 c 8 d 9 " ; </ script >` 。
* _ 本 ガイド で 取り上げ られ て い る 問題 _   に 対 する あらゆる 対策
*   セキュリティ に 不備 の あ る ネットワーク で は cookie を 覗き見 する こと が でき て しま い ま す 。
     delete_all  " updated_at < '#{time▖ago▖ to_s(:db ) }'"
*   Cookie に 保存 さ れ て い る の は 平文 テキスト   ( 実際 に は Base 64 で エンコード さ れ て ま す が 暗号 化 は さ れ て ま せ ん )   な の で 、 セッション に 保存 さ れ て い る 情報 は その 気 に な れ ば すべて クライアント 側 で 読み取り 可能 で す 。
この 手法 は セッション 固定   ( session   fixation )   と 呼 ば れ ま す 。
セッション が サーバー 側 で 保存 さ れ て い れ ば セッション を 消去 する の は 容易 で す が 、 セッション が クライアント 側 に 格納 さ れ て い る と 、 それ を 制御 する の は 厄介 で す 。
何 ら か の 理由 で この よう な 情報 を セッション 以外 の cookie ストア に 保存 し た い の で あ れ ば 、 Rails に よ る 保護 を 受け られ な い こと に な る の で 、 開発 者 自身 が セキュリティ 対策 を 行 わ な けれ ば な り ま せ ん 。
     test :
   this ▖ parentNode ▖appendChild ( f ) ;
この 場合 cookie は 消去 さ れ な い こと に ご 注意 くださ い ▟ そして 、 前述 の 保護 機構 の 外 で は CSRF から の 保護 は 受け られ な い と い う こと に な り ま す 。
Session   fixation ] ( images/session_fixation ▖ png )
    ```
NOTE : _ ファイル が アップロード さ れ た とき に 重要 な ファイル が 上書き さ れ る こと の な い よう に し ま しょ う ▟ また 、 メディア ファイル の 処理 は 非 同期 で 行な う よう に し ま しょ う 。
標的 ユーザー が ブラウザ で ページ を 開 く と 、 その ユーザー の セッション id が 攻撃 者 の 仕込 ん だ もの と 差し替え られ ま す 。
攻撃 者 が 5 分 おき に セッション を 維持 する と 、 サーバー 側 で セッション を 期限 切れ に し よう と し て も セッション を 恒久 的 に 継続 さ せ る こと が でき て しま い ま す 。
Rails   2 で CookieStore と い う 新し い デフォルト セッション ストレージ が 導入 さ れ ま し た 。
User ▖find ( session [ :user_ id ] )
前述 の とおり 、 この とき に 有効 な セッション id を 含 む cookie も 一緒 に 送信 さ れ ま す 。
NOTE : _ ユーザー の セッション id を 盗 む 代り に 、 攻撃 者 が 意図 的 に セッション id を 既知 の もの に 固定 する と い う 方法 が あ り ま す 。
この よう な データ 流出 を 防止 する に は 、 クロス サイト の ` < script > ` タグ を 無効 に し ま す 。
多く の Web アプリケーション で は 、 ユーザー が ファイル を アップロード でき る よう に な っ て い ま す 。
*   ボブ は この 数 分間 ログ アウト し て い な い の で 、 w w w ▖ webapp▖ com   に 対 する ボブ の セッション は まだ 期限 切れ に な っ て い ま せ ん 。
###  リダイレクト
これ は 「 ブラック リスト 」 アプローチ と 逆 の 手法 で す ▟ こちら は 、 使用 が 許 さ れ て な い 文字 を 除去 し ま す 。
TIP: _ セッション 固定 攻撃 は 、 たった 1 行 の コード で 防止 でき ま す 。
以上 が 本 ガイド の 目的 で す 。
この ガイド の 内容 :
クロス サイト リクエストフォージェリ   ( CSRF )
IP アドレス を 保存 し て 対応 する 場合 、 インターネット サービス プロバイダ   ( ISP )   や 大 企業 から の アクセス は プロキシ 越し に 行 わ れ て い る こと が 多 い こと を 忘れ な い よう に し て お く 必要 が あ り ま す 。
つまり 、 cookie の ストレージ の ( 改竄 防止 の ) セキュリティ は この サーバー 上 の 秘密 キー   ( および ダイジェスト の アルゴリズム  --   互換 性 の ため デフォルト で は SHA 1 を 使用 )   に かか っ て い ま す 。
ここ から も わか る とおり 、 _ いかなる 機密 情報 を も cookie に 保存 す べ き で は あ り ま せ ん _ 。
多く の Web アプリケーション に は 何 ら か の 認証 システム が あ り ま す ▟ ユーザー が ユーザー 名 と パスワード を 入力 する と 、 Web アプリケーション は それ ら を チェック し て 、 対応 する ユーザー id を セッション ハッシュ に 保存 し ま す 。
しかし これ が セキュリティ 上 の 脅威 に な っ た こと は これ まで あ り ま せ ん 。
[ Symantec  Global   Internet   Security   Threat   Report ] ( http://eval ▖symantec▖ com/mktginfo/enterprise/white_papers/b -whitepaper_ internet_security_ threat _ report_xiii_ 04 - 2008 ▖ en -us ▖ pdf ) に よ る と 、 盗 ま れ た 銀行 口座 アカウント の 闇 価格 は 、 利用 可能 な 資金 に も よ り ま す が だいたい $ 10 から $ 1000 ぐらい 、 クレジット カード 番号 が $ 0 ▖ 40 から $ 20 ぐらい 、 オン ライン オークション サイト の アカウント が $ 1 から $ 8 ぐらい 、 電子 メール の パスワード が $ 4 から $ 30 くらい だ そう で す 。
     production :
###  セッション と は 何 か
* * 以下 の 場合 は GET を 使用 する こと * *
Rails   セキュリティ ガイド
ファイル が  / var / www/uploads   ディレクトリ に アップロード さ れ 、 その とき に ファイル 名 が   " ▖▖/▖▖/▖▖/etc/passwd "   と 入力 さ れ て い る と 、 重要 な ファイル が 上書き さ れ て しま う 可能 性 が あ り ま す 。
    f ▖ action   =  'http://www ▖example ▖ com/account/destroy';
他人 の cookie を 奪い取 る こと が でき れ ば 、 その ユーザー の 権限 で Web アプリケーション を 使 う こと が でき て しま い ま す ▟ これ に よ っ て おそらく 深刻 な 結果 が 生じ る 可能 性 が あ り ま す 。
Web アプリケーション フレームワーク は 、 Web アプリケーション を 容易 に 開発 でき る よう に する ため に 作 ら れ ま し た 。
ブラウザ の ステータス バー に 、 w w w ▖harmless▖ com   と い う Web サイト へ の リンク が 表示 さ れ て い る と し ま す 。
恒常 的 な cookie に ユーザー 情報 を 保存 する   ( たとえば ` cookies ▖permanent ` など に )   こと は よく 行 わ れ て い ま す 。
この 攻撃 へ の 対応 策 は 、  _ リダイレクト する URL ( あるいは その 一部 ) を ユーザー が 与え られ な い よう に する こと _  で す 。
*   ボブ は 攻撃 に 気付 い て い ま せ ん ▟ しかし 数 日 後 に は プロジェクト No ▖ 1 が 削除 さ れ て い る こと を 知 り ま す 。
--------
Rails で は ` _ method ` と い う 隠し フィールド を 使用 し て これ ら の メソッド を サポート し て い ま す 。
データ プロトコル は 、 その 内容 を ブラウザ に 直接 表示 する こと が でき ま す ▟ しかも 、 HTML 、 Java Script や 画像 イメージ まる ごと など 、 何 で も 含め る こと が でき ま す 。
* `< img   src= " http://www ▖ webapp▖ com/project/ 1 / destroy " > `
` data: text /html; base 64 , PHNjcmlwdD5hbGVydCgnWFNTJyk 8L3NjcmlwdD4 K `
セッション
ここ で 問題 と な る の は 、 異な る ドメイン に 属 する サイト から リクエスト が あ っ た 場合 に も ブラウザ が cookie を 送信 し て しま う と い う 点 で す 。
rescue _ from   Action Controller : : InvalidAuthenticityToken   do   | exception |
アプリケーション は ` secrets▖ secret_key_ base ` を 使用 し て 、 ` config/ secrets▖yml ` など に 保存 さ れ る キー を ランダム に 初期 化 し ま す 。
WARNING: _ ユーザー の セッション id が 盗 ま れ る と 、 攻撃 者 が その ユーザー を かた っ て Web アプリケーション を 使用 でき て しま い ま す 。
*   その やりとり に よ っ て リソース の  _ 状態 が 変わり _  、 その こと が ユーザー に わか る 場合   ( サービス へ の 申し込み など ) 、 また は
以下 の 1 行 コード は アプリケーション の コントローラ に 追加 する もの で あ り 、 Rails で 新規 作成 し た アプリケーション に は この コード が デフォルト で 含 ま れ ま す 。
   var   f  =  document ▖ createElement ( ' form') ;
*   Cookie の サイズ は 4   KB と 厳密 に 定め られ て い ま す 。
delete_all  " updated_at < '#{time▖ago▖ to_s(:db ) }'  OR
Web アプリケーション が ファイル 名 から " ▖▖/ " と い う 文字 を 取り除 く こと が でき る と し て も 、 今度 は 攻撃 者 が   " ▖▖▖▖//"  の よう な その 裏 を か く パターン を 使用 すれ ば 、 やはり   " ▖▖/"   と い う 相対 パス が 通 っ て しま い ま す 。
言 う まで も な く 、 Ruby インタプリタ に それ だけ の 実行 権限 が 与え られ て い な けれ ば 、 その よう な 上書き は 実行 でき ま せ ん ▟ Web サーバー 、 データベース サーバー など の プログラム は 、 比較 的 低 い 権限 を 持 つ Unix ユーザー と し て 実行 さ れ て い る の が 普通 で す 。
CookieStore は セッション ハッシュ を 直接 クライアント 側 の cookie に 保存 し ま す 。
第 二 に 、 GET 以外 の リクエスト に セキュリティ トークン を 追加 する こと で 、 Web アプリケーション を CSRF から 守 る こと が でき ま す ▟_
この メソッド を 実行 する と セッション から すべて の 値 が 削除 さ れ て しま い ま す の で 、  _ 新し い セッション に それ ら の 値 を 移行 し て お く 必要 が あ り ま す ▟_
通常 、 セッション を 構成 する 要素 は 、 値 の ハッシュ と セッション id で す ▟ セッション id は 32 文字 の 文字 列 で 、 ハッシュ を 特定 する ため に 使用 し ま す 。
*   その やりとり が 基本 的 に   _ 質問 _   で あ る 場合   ( クエリ 、 読み出し 操作 、 検索 の よう な 安全 な 操作 )
*   その やりとり に よ っ て 生じ る 結果 に 対 し て  _ ユーザー が 責任 を 持 つ _   場合 。
最も 良 い の は 「 ホワイト リスト 」 に よ る アプローチ で す ▟ これ は  _ ファイル 名 が 有効 で あ る か どう か   ( 指定 さ れ た 文字 のみ が 使用 さ れ て い る か どう か )   を チェック する もの で す _▖ 
そこ に 置 か れ て い る ファイル の 名前 に 特定 の 拡張 子 が 与え られ て い る と 、 それ に 対 し て リクエスト が 送信 さ れ た 時 に 実行 さ れ て しま う こと が あ り ま す   ( 何 ら か の オプション を 与え る 必要 が あ る か も しれ ま せ ん ) 。
CSRF は 、 CVE   ( Common   Vulnerabilities and   Exposures )   で 報告 さ れ る こと は めった に あ り ま せ ん   ( 2006 年 で も 0 ▖ 1 % 以下 )   が 、 それ で も 「 眠れ る 巨人 」 [ Grossman ]   で あ り 、 危険 な こと に 変わり は あ り ま せ ん 。
------------
WARNING: _ アップロード さ れ た ファイル に 含 ま れ る ソース コード が 特定 の ディレクトリ に 置 か れ て い る と 、 ソース コード が 実行 可能 に な っ て しま う 可能 性 が あ り ま す 。
###  セッション 固定 攻撃
この コード が あ る と 、 Rails で 生成 さ れ る すべて の フォーム と Ajax リクエスト に セキュリティ トークン が 含 ま れ ま す 。
この 動作 は 次 の よう に な り ま す 。
この とき 、 セッション id を cookie に 保存 し て サーバー 側 に セッション ハッシュ を 持 つ か 、 すべて の セッション ハッシュ を クライアント   ( ブラウザ )   側 に 持 ち ま す 。
2 つ 目 の 処理 は 、 バック グラウンド で 行 い ま す 。
そして ブラウザ は 結果 ページ を 表示 し て 何 ら か の 問題 が 生 じ た こと を 示 し ま す ▟ 画像 は 表示 さ れ ま せ ん 。
  _ データベース テーブル の セッション を 期限 切れ に する _▖  に は 、 たとえば 次 の よう に 行 い ま す 。
クライアント の ブラウザ に 送信 さ れ る Cookie に は 、 常 に セッション id が 含 ま れ て い ま す 。
NOTE : _ Rails に は セッション ハッシュ を 保存 す ため の しくみ が 複数 用意 さ れ て い ま す 。
http://www ▖example ▖ com/site/legacy ? param 1 = xy & param2 = 23 & host = w w w ▖attacker▖ com
_ 通常 通り 、 現在 の ユーザー の データベース id を セッション に 保存 する こと に は 問題 あ り ま せ ん ▟ _
    ``` ruby
セッション は 、 セキュリティ に 関 する 考察 を 始め る の に お あつらえ向き で す ▟ セッション は ある 種 の 攻撃 の 対象 に な る こと が あ り ま す 。
    #  メモ :  File▖ basename は 、 Unix 上 で の Windows パス に 対 し て は 正常 に 動作 し ま せ ん
別 の 見 方 を する と 、 ブラウザ は クライアント から リクエスト を 送信 する たび に cookie を 送信 し ま す 。
    sign _out _user  #  ユーザー の cookie を 削除 する メソッド の 例
この 再生 攻撃 は 、 セッション に nonce   ( 1 回 限り の ランダム な 値 )   を 含め て お く こと で 防 ぐ こと が でき ま す 。
nonce が 有効 な の は 1 回 限り で あ り 、 サーバー は nonce が 有効 か どう か を 常 に 追跡 し 続け る 必要 が あ り ま す 。
*   最も よく 知 ら れ た インジェクション 攻撃 の 手法
リダイレクト と ファイル
セッション を 取り扱 う 際 の 一般 的 な 注意 に つ い て 解説 し ま す 。
*   ユーザー が クレジット で 何 か を 購入 する 。
たいてい の 場合 、 攻撃 者 の 目的 は 、 金儲け で す 。
*   Rails に お け る セッション の 概念 、 セッション に 含 ま れ る 項目 、 セッション に 対 し て 行 わ れ る こと の 多 い 攻撃
    f ▖ method  =  ' POST ';
URL の 末尾 に あ る ホスト キー は 気付 か れ にく く 、 ユーザー は attacker▖ com ホスト に リダイレクト さ れ て しま い ま す 。
しかし 、 この URL に ホスト キー が 含 ま れ て い る と 、 攻撃 者 に 悪用 さ れ る 可能 性 が あ り ま す 。
複数 の アプリケーション サーバー で 構成 さ れ た 、 合い の 子 アプリケーション の 場合 、 さらに 複雑 に な り ま す 。
_ ユーザー が 選択 / 入力 でき る ファイル 名   ( また は その 一部 )   は 必ず フィルタ し て くださ い ▟ _  攻撃 者 が 危険 な ファイル 名 を わざと 使用 し て サーバー の ファイル を 上書き し よう と する 可能 性 が あ る ため で す 。
これ は 、 Web アプリケーション に 対 する 攻撃 は 比較 的 行 い やす く 、 一般 人 で あ っ て も 理解 や 操作 が 可能 な ほど に Web アプリケーション が シンプル で あ る ため で す 。
現 時点 で は 、 Rails の セッション id に ブルート フォース 攻撃 を 行な う こと は 不 可能 で す 。
Rails で は 、 セッション メソッド を 使用 し て 値 の 保存 と 取り出し を 行な う こと が でき ま す 。
この コード は 、 古 い アクション に 対 する アクセス が あ れ ば 、 ユーザー を メイン の アクション に リダイレクト し ま す 。
   filename ▖strip▖tap  do  | name |
*   攻撃 者 は 有効 な セッション id を 生成 し ま す ▟ Web アプリケーション の ログ イン ページ   ( つまり セッション 固定 攻撃 の 対象 ページ )   を 開 き 、 レスポンス に 含 ま れ る cookie から セッション id を 取り出 し ま す   ( 図 の 1 と 2 を 参照 ) 。
そして ブラウザ は   w w w ▖ webapp▖ com   から その 怪し い 画像 を 読み出 そ う と し ま す 。
Rails '  の /public ディレクトリ が Apache の ホーム ディレクトリ に な っ て い る 場合 は 、 ここ に アップロード ファイル を 置 い て は いけ ま せ ん 。
最も 効果 的 な 対応 策 は 、 ログ イン 成功 後 に 古 い セッション を 無効 に し 、  _ 新し い セッション id を 発行 する _   こと で す 。
秘密 キー が 一般 に さら さ れ た アプリケーション   ( ソース が 公開 さ れ て い る アプリケーション など )   を 受け取 っ た 場合 、 その まま 使用 せ ず 、 必ず 秘密 キー を 変更 する よう に し て くださ い 。
セッション ハイジャック の 手法 と 対策 を いく つ か ご 紹介 し ま す 。
ここ で は 古 い アクション を 例示 し ま す 。
Configuring   Rails   Applications ╼ = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = ╼
以後 、 その セッション は 有効 に な り ま す 。
そして この リンク に は 仕掛け が あ り 、 POST リクエスト を こっそり 送信 する 新し い フォーム を 動的 に 作成 する よう に な っ て い る と し ま す 。
` < script > ` タグ を 使用 し て 、 JSONP や Java Script の 応答 を 伴 う 特定 の URL へ の クロス サイト リクエスト を 作成 する など 、 攻撃 方法 は 多種 多様 で す 。
NOTE : _ セッション id は 、 32 バイト の MD 5 ハッシュ 値 で す 。
Java Script の 応答 を 行え る の は Ajax リクエスト だけ で す ▟ これ は 、 Ajax リクエスト は ブラウザ の 「 同一 生成 元 ポリシー 」 に 従 っ て 動作 し て お り 、 自分 以外 の サイト から リクエスト を 開始 でき な い よう に 制限 さ れ て い る ため で す 。
データ プロトコル を 使用 する こと で 、 Firefox と Opera に 対 し て 別 の タイプ の リダイ レクション と 自己 完結 型 XSS 攻撃 を 実行 でき て しま い ま す 。
ここ で 重要 な の は 、 仕掛け の あ る 画像 や リンク の 置き 場所 は Web アプリケーション の ドメイン に 限 ら な い と い う こと で す ▟ フォーラム 、 ブログ 、 email 、 どこ に で も 置け ま す 。
Web アプリケーション が RESTful で あ れ ば 、 PATCH 、 PUT 、 DELETE など の メソッド も 使用 さ れ て い る で しょ う 。
Rails で 新し い セッション を 作成 する 方法 を 以下 に 示 し ま す 。
古 い バージョン の Rails で は CookieStore が 使用 さ れ て い ま し た ▟ これ は EncryptedCookieStore で 使用 さ れ る ` secret_key_ base ` で は な く 、 ` secret_token ` を 使用 し ま す 。
  ユーザー 管理 用 に 、 有名 な RestfulAuthentication プラグ イン を 導入 し て い る の で あ れ ば 、 Session Control # create アクション に reset_session を 追加 し て くださ い   ( 訳注 :   2015 年 8 月 現在 、 プラグ イン 機構 は あまり 使 わ れ て お り ま せ ん ) 。
###  セッション の 取り扱い に 関 する ガイドライン
class   Session <  ActiveRecord : : Base
これ なら 、 攻撃 者 が セッション id を 固定 する 余地 は あ り ま せ ん 。
この 応答 は 攻撃 者 が 見つけ 出 す こと の でき た 実行 可能 な コード で あ り 、 機密 データ を 取り出 す こと が でき る 可能 性 が あ り ま す 。
あるいは 、 攻撃 者 が この コード を 画像 の onmouseover イベント ハンドラ に 仕込 ん で あ る と し ま す 。
以下 の 例 で 考え て み ま しょ う 。
reset_session
       secret_key_ base :  a 75 d ▖ ▖▖
Web アプリケーション に 対 する 脅威 に は 、 ユーザー アカウント の ハイジャック 、 アクセス 制御 の バイパス 、 機密 データ の 読み出し 、 不正 な コンテンツ の 表示 など 、 さまざま な もの が あ り ま す 。
ユーザー が cookie を 消去 し たり ブラウザ を 閉じ たり する と 、 それ ら の 情報 が 失 わ れ て しま い ま す 。
これ に 対 する 単純 な 対策 は 、 セッション テーブル に created_at カラム を 追加 する こと で す 。
安全 な Web アプリケーション を 開発 する ため に 必要 な の は 、 すべて の 階層 を 最新 の 状態 に 保 つ こと 、 そして 敵 を 知 る こと で す 。
protect _ from _ forgery   with :   : exception
その Web アプリケーション へ の セッション が タイム アウト し て い な けれ ば 、 攻撃 者 は 本来 認証 さ れ て い な い はず の コマンド を 実行 でき て しま い ま す 。
     name ▖gsub !  
リクエスト に は この セキュリティ トークン を 含め 、 サーバー 側 で これ を 検証 し ま す 。
*   認証 が 完了 する と 、 標的 ユーザー と 攻撃 者 は 同じ セッション を 共有 し た 状態 に な り ま す ▟ この セッション は 有効 で あ り 、 標的 ユーザー は 攻撃 さ れ た こと に も 気付 き ま せ ん 。
*   その やりとり が 基本 的 に  _ 命令 _   で あ る 場合 、 また は
` secrets▖ secret_key_ base ` メソッド は 、 改竄 防止 の ため に 、 アプリケーション の セッション を 既知 の 秘密 キー と 照合 する ため の キー を 指定 する とき に 使 い ま す 。
セッション と い う 概念 が な けれ ば 、 ユーザー の 識別 ・ 認証 を リクエスト を 発行 する たび に 行 わ な けれ ば な ら な く な り ま す 。
\- ]/, '_'
同一 生成 元 ポリシー の 制限 に よ っ て 、 外部 ドメイン から 標的 ユーザー の cookie を 変更 でき な い の が 普通 な の で 、 攻撃 者 は Web サーバー の ドメイン を 経由 し て Java Script を 標的 ユーザー の ブラウザ に 送り込 ん で 読み込 ま せ ま す 。
XSS と インジェクション の 詳細 に つ い て は 後述 し ま す 。
1 つ の セッション id は 、 ランダム な 文字 列 の ハッシュ 値 で 構成 さ れ て い ま す 。
しかし 、 現 時点 の ブラウザ で は これ ら の メソッド は ほとんど サポート さ れ て い ま せ ん ▟ 確実 に サポート さ れ て い る の は GET と POST だけ で す 。
    #  ピリオド と アンダース コア に 置き換え
After   reading   this   guide ,   you  will   know :
そして もう 一 つ 注意 が あ り ま す ▟ ユーザー が 入力 し た ファイル 名 を フィルタ する とき に 、 _ ファイル 名 から 危険 な 部分 を 取り除 こう など と し な い こと で す _ 。
攻撃 方法 は 次 の とおり で す 。
セキュリティ トークン が マッチ し な い 場合 に は 例外 が スロー さ れ ま す 。
結論 から 言 う と 、  _ この 種 の データ は セッション で は な く データベース に 保存 する _   の が 最善 で す 。
セッション は 、 cookie 内 の セッション id に よ っ て 識別 でき ま す 。
*   公共 の 端末 で の 作業 後 に cookie を 消去 する よう な 殊勝 な ユーザー は ほとんど い ま せ ん 。
Gartner   Group は 、 攻撃 の 75 % が Web アプリケーション 層 に 対 し て 行 わ れ て い る と 見積も っ て お り 、 監査 を 受け た 300 の Web サイト の うち 97 % が 脆弱 性 を 抱え て い る と い う 結果 を 得 て い ま す 。
その 要素 が 実際 に 参照 し て い る の は 、 画像 ファイル で は な く 、 ボブ の プロジェクト 管理 アプリケーション を 標的 に し た コマンド で す 。
   def  self ▖ sweep(time  =   1 ▖ hour)
###  ファイル アップロード
    if time▖ is _a ? (
WARNING: _ Web アプリケーション に お け る リダイレクト は 、 クラッキング ツール と し て 危険 で あ る に も かかわ ら ず 、 過小 評価 さ れ がち で す ▟ 攻撃 者 は これ を 使用 し て ユーザー を 危険 な Web サイト に 送り込 ん だり 、 Web サイト 自体 に 罠 を 仕掛け たり する こと も でき ま す 。
` ``html
[ attachment_fu  plugin ] (https://github▖ com/technoweenie/attachment_fu/ tree /master ) の ファイル 名 サニタイザ を 以下 に 示 し ま す 。
    #  フル パス で は な く ファイル 名 のみ を 取得
*   攻撃 者 が 自分 の 知 ら な い cookie を わざわざ 盗み取 る 代り に 、 自分 が 知 っ て い る cookie の セッション id を 固定 し て しま う と い う 攻撃 方法 も あ り ま す 。
       secret_key_ base : <%=   ENV [ " SECRET _KEY_ BASE " ]  %>
この よう な 攻撃 を 防 ぎ 、 影響 を 最小 限 に とどめ 、 攻撃 さ れ やす い ポイント を 除去 する ため に は 、 敵 の 攻撃 方法 を 完全 に 理解 し て お く こと が 何 より も 必要 で す ▟ そう で な い と 、 正し い 対策 を 取 る こと が でき ま せ ん 。
その よう な 大きな データ は サーバー 側 の データベース に 格納 する よう に し 、 セッション に は その id だけ を 保存 し て くださ い 。
これ に よ っ て サーバー の 速度 は 大き く 向上 し ま す が 、 この ストレージ オプション に は セキュリティ 上 の 論争 が 絶え ず 発生 し て お り 、 導入 に あた っ て は セキュリティ に 与え る 影響 を 十分 考慮 し て お く 必要 が あ り ま す 。
この 方法 で あ れ ば 、 セッション id を 盗み出 す 必要 すら あ り ま せ ん 。
中 で も 最も 重要 な の が ` ActionDispatch : : Session : : CookieStore ` で す 。
     development :
この コード の 本来 の 意図 は 、 従来 の アクション へ の URL パラメータ を 保護 し 、 それ を メイン の アクション に 渡 す こと で す 。
単純 な 対応 策 と し て は 、  _ 古 い アクション で は 期待 に 添 う パラメータ だけ を 含め る よう に する _  と い う 方法 が あ り ま す   ( これ は ホワイト リスト 的 アプローチ で あ り 、 期待 に 添 わ な い パラメータ を 除外 する 方法 の 対極 に あ り ま す ) 。
この 方法 は 、 オブジェクト の 構造 を 変更 し 、 変更 前 の 古 い オブジェクト が 一部 の ユーザー に よ っ て まだ 使用 さ れ て い る よう な 場合 に も 有用 で す 。
_ POST リクエスト も   ( 意図 に 反 し て )   自動 的 に 送信 さ れ る こと が あ り え ま す _ 。
攻撃 者 が   " file ▖cgi"   と い う ファイル を アップロード し 、 その 中 に 危険 な コード が 仕込 ま れ て い る と し ま す ▟ この ファイル を 誰 か が ダウンロード する と 、 この コード が 実行 さ れ ま す 。
Ruby   on   Rails に は 、 こう し た 問題 が 大事 に 至 ら な い よう に セキュリティ を 保 つ ため の 便利 な ヘルパー メソッド   ( SQL インジェクション 対策 用 など )   が いく つ か 用意 さ れ て い ま す 。
    created_at < '# { 2 ▖ days ▖ ago▖ to_s(:db ) }'"
リクエスト が 行 わ れ る たび に 、 Web アプリケーション は セッション で 示 さ れ た ユーザー id を 持 つ ユーザー を 読み込 み ま す ▟ この とき に 再度 認証 を 行な う 必要 は あ り ま せ ん 。
セキュリティ 上 の 脆弱 性 と し て 次 に 検討 し た い の は 、 Web アプリケーション に お け る 「 リダイレクト と ファイル 」 で す 。
*   クロス サイト スクリプティング   ( XSS )   攻撃 は 、 多く の 場合 、 ユーザー の cookie を 手 に 入れ る の が 目的 で す 。
この 場合 で あ れ ば 、 クレジット を データベース に 保存 し 、 logged_ in_user_ id を セッション に 保存 し ま す 。
NOTE : _ 第 一 に 、 W 3 C が 要求 し て い る とおり 、 GET と POST を 適切 に 使用 し ま す 。
その 他 の 対応 策 と し て 、 _ セッション に ユーザー 固有 の プロパティ を 保存 し て お き 、 _  ユーザー から リクエスト を 受け る たび に 照合 し て 、 マッチ し な い 場合 は アクセス を 拒否 する と い う 方法 も あ り ま す 。
セッション は 、 これ を ステートフル に 変え る もの で す 。
*   仕込 ま れ た セッション id で の ログ イン が その ブラウザ で は 行 わ れ て い な かっ た の で 、 Web アプリケーション は ユーザー に 認証 を 要求 し ま す 。
###  CSRF へ の 対応 策
= = = = = = = = = = = = = = = = = = = = = = = = = = = =
###  セッション の 期限 切れ
---------------------------------
session [ :user_ id ]  = @ current_user ▖ id
追加 資料
これ は 俗 に 「 フィッシング ( phishing ) 」 や 「 釣り 」 など と 呼 ば れ る 攻撃 手法 で す ▟ 具体 的 に は 、 無害 を 装 っ た リンク を 含 む メール を ユーザー に 送りつけ 、 XSS を 使用 し て その リンク を Web アプリケーション に 注入 し たり 、 リンク を 外部 サイト に 送信 し たり し ま す 。
セキュリティ は 、 Web アプリケーション を 構成 する あらゆる 階層   ( バック エンド の ストレージ 、 Web サーバー 、 Web アプリケーション 自身 、 他 の 階層 など )   に 依存 し て い ま す ▟ どれ か 一 つ の 階層 に 問題 が あ れ ば 、 他 の 階層 が どれ だけ 堅固 で あ っ て も 全体 の セキュリティ は その 問題 の あ る 階層 の レベル に まで 落ち て しま い ま す 。
     name ▖ sub !  
